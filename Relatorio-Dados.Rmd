---
title: ""
output: 
    pdf_document
link-citations: true
nocite: | 
  @ref1, @ref2, @ref3, @ref4
---

\centering
\raggedright
\begin{center}
```{r pressure, echo=FALSE,out.width = '50%',fig.align='center'}
knitr::include_graphics("unb.jpg")
```
\Large Universidade de Brasília\\
IE - Departamento de Estatística
\end{center} 
\vskip 12em
\begin{center}
\Large \textbf{Trabalho Final - Análise de Dados Categorizados}
\par
\vskip 7em
\end{center}
\setlength{\baselineskip}{.5cm}
\small \textbf{}
\par
\vskip 5em

\begin{flushright}
\Large Eduardo Felipe Machado Côrtes\\
\small 170140784\\
\Large Laura Cristina Melo Teixeira\\
\small 190016051\\
\Large Marcelo Pereira De Souza Fleury\\
\small 190017252
\vskip 2em
\Large Professora: Maria Teresa Leão Costa
\end{flushright}

\vskip 6em
\begin{center}
\setlength{\baselineskip}{.5cm}
Brasília\\
\vskip 1em
Outubro de 2022
\end{center}
\newpage
\tableofcontents
\newpage

```{r setup, include=FALSE,warning=FALSE,message=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.align = 'center'
)
```


# 1. Introdução e Objetivos

No contexto de pacientes que desenvolvem câncer, é de suma importância, para se decidir qual tratamento utilizar, saber se o câncer já se espalhou para os linfonodos próximos. Tal condição é denominada envolvimento nodal. Tendo isso em vista, foi feito um estudo com coleta de variáveis pré-operatórias de pacientes com câncer de próstata, assim como se desenvolveram ou não o quadro de envolvimento nodal. 

Desta forma, o presente estudo busca elucidar quais fatores impactam na probabilidade de um determinado paciente, que desenvolveu câncer de próstata, não ter envolvimento nodal, assim como possibilitar a predição em futuros pacientes. Para entender quais variáveis são importantes para a predição e de que forma elas estão relacionadas, será feito um estudo exploratório, seguido de uma análise inferencial por meio de modelos de regressão logística.

\newpage

# 2. Metodologia

Para alcançar os objetivos citados, este estudo dispõe de uma amostra aleatória de 102 pacientes, contendo as seguintes variáveis pré-operatórias: resultado da radiografia (positivo ou negativo, tendo sido coletada como 1 ou 0, respectivamente), estágio do tumor (menos grave ou mais grave, codificada como 0 ou 1, respectivamente), nível de fosfatase ácida (valores multiplicados por 100) e envolvimento nodal (sim ou não, coletada como 0 ou 1, respectivamente). Será adotado um nível de significância $\alpha=5\%$. As análises foram feitas por meio do software estatístico R (versão 4.1.2), cujo código está presente na seção de apêndice.

Para fins de análise exploratória dos dados disponíveis, foram feitos gráficos e tabelas, além de testes de associação para entendimento da relação das variáveis com a presença de envolvimento nodal. Em seguida, a modelagem foi feita primeiramente por meio de modelos de regressão logística simples (considerando apenas o nível de fosfatase ácida), seguido de regressão logística múltipla. Tal abordagem foi escolhida por ser esse o modelo probabilístico capaz de explicar o comportamento de variáveis categorizadas, predizendo as probabilidades de ocorrência de suas categorias, conforme variáveis explicativas, tanto quantitativas como qualitativas.

\newpage

# 3. Resultados

## 3.1 Análise Exploratória

Com o intuito de apresentar e compreender as variáveis presentes na amostra, segue-se com as análises exploratórias pertinentes, levando em consideração as 102 observações.

```{r}
# Carregar os dados
library(readxl)
library(tidyverse)
setwd(getwd())

amostra <- read_xlsx(path="Amostra_g06.xlsx",
                     sheet = "Amostra_g06")

# Seleciona a amostra n=51
set.seed(12345)
rows_index <- sample(1:nrow(amostra),51)
treinamento <- amostra[rows_index,]
validacao <- amostra[-rows_index,]

#Define o tema dos gráficos
tema <- theme_bw()+
  theme(axis.title.y=element_text(colour="black", size=14),
        axis.title.x = element_text(colour="black", size=14),
        axis.text = element_text(colour = "black", size=14),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        plot.title = element_text(hjust = 0.5, size=12),
        legend.position = "bottom",
        legend.text=element_text(size=18))

```


### 3.1.1 Análises Univariadas

#### 3.1.1.1 Variáveis Explicativas


O resultado da radiografia, variável qualitativa nominal, está representada no gráfico abaixo.

```{r, fig.width=8,out.width = '80%'}
# X1 - Resultado da radiografia
# 0 – negativo 1 – positivo

Fr <- table(amostra$X1)
Pr <- as.data.frame(round(prop.table(Fr) , digits=4 ) * 100 )
colnames(Pr)<-c("Var1","Pr" )
comp <- merge(Fr,Pr, by= "Var1" )
comp$Pr<-paste(gsub( "\\." , "," ,comp$Pr ) , "%" , sep="")
comp$Var1 <- c("Negativo","Positivo")

# Grafico barras
ggplot(comp,aes(x=Var1,y=Freq,label=Pr))+
  geom_bar(stat="identity",fill="#6E6DB8")+
  geom_text(vjust=-0.5,size=4)+
  labs(x="Resultado da radiografia",y="Frequência Absoluta")+
  tema

```

A maioria dos pacientes amostrados (cerca de 71%) apresentou o resultado da radiografia negativo. Em relação ao estágio do tumor, variável qualitativa ordinal, observa-se o seguinte gráfico de barras.


```{r, fig.width=8,out.width = '80%'}
# X2 - Estágio do tumor
# 0 – menos grave ou 1 – mais grave
Fr <- table(amostra$X2)
Pr <- as.data.frame(round(prop.table(Fr) , digits=4 ) * 100 )
colnames(Pr)<-c("Var1","Pr" )
comp <- merge(Fr,Pr, by= "Var1" )
comp$Pr<-paste(gsub( "\\." , "," ,comp$Pr ) , "%" , sep="")
comp$Var1 <- c("Menos grave","Mais grave")

# Grafico barras
ggplot(comp,aes(x=Var1,y=Freq,label=Pr))+
  geom_bar(stat="identity",fill="#6E6DB8")+
  geom_text(vjust=-0.5,size=4)+
  labs(x="Estágio do tumor",y="Frequência Absoluta")+
  tema

```


Cerca de 54% dos indivíduos possui um estágio de tumor mais grave, enquanto 46% um estágio menos grave. A análise do nível de fosfatase ácida está apresentada a seguir.


```{r, fig.width=8,out.width = '80%'}
# X3 - Nível de fosfatase ácida

# Boxplot

ggplot(amostra, aes(x=factor(""), y=X3)) +
  geom_boxplot(fill=c("#6E6DB8"),width=0.5) +
  guides(fill=FALSE) +
  stat_summary(fun.y="mean",geom="point",shape=23,size=3,
               fill="white") +
  labs(x="",y="Nível de fosfatase ácida") +
  tema
```

```{r}
# Tabela medidas resumo
library(kableExtra)

summaryX3 <- summary(amostra$X3)

tbl1 <- data.frame("Estatística"=c("Mínimo","1º Quartil",
                                   "Mediana","Média","3º Quartil",
                                   "Máximo","Desvio Padrão"),
                   "Valor"=c(summaryX3,sd(amostra$X3)),
                   check.names = F)

rownames(tbl1)<-NULL

tbl1 %>%
  kableExtra::kbl(.,digits=2,align=c('l','c'),booktabs = T,
                  caption = 'Medidas resumo do nível de fosfatase ácida') %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")

```

O nível de fosfatase ácida é de, em média, 69, um valor próximo da mediana (61,5), mas que foi um pouco deslocado por conta de alguns pontos discrepantes (*outliers*) presentes na amostra, cujos valores são 136, 137, 186 e 187. Portanto, de forma geral, pode-se dizer que os valores de fosfatase ácida estão distribuídos de forma assimétrica à direita e com um valor de variância que não é muito alto, o que pode ser visto pelo seu coeficiente de variação de 42%.

Por fim, a variável resposta do estudo, o envolvimento nodal, é apresentada na seção seguinte.


#### 3.1.1.2 Variável Resposta

```{r, fig.width=8,out.width = '80%'}
# X4 - Envolvimento nodal
# 0 – sim 1 – não

Fr <- table(amostra$X4)
Pr <- as.data.frame(round(prop.table(Fr) , digits=4 ) * 100 )
colnames(Pr)<-c("Var1","Pr" )
comp <- merge(Fr,Pr, by= "Var1" )
comp$Pr<-paste(gsub( "\\." , "," ,comp$Pr ) , "%" , sep="")
comp$Var1 <- c("Sim","Não")

# Grafico barras
ggplot(comp,aes(x=Var1,y=Freq,label=Pr))+
  geom_bar(stat="identity",fill="#6E6DB8")+
  geom_text(vjust=-0.5,size=4)+
  labs(x="Envolvimento nodal",y="Frequência Absoluta")+
  tema

```

O envolvimento nodal, variável qualitativa nominal, é uma condição presente na maior parte dos pacientes pesquisados, cerca de 59%. Enquanto os 41% restantes não apresentam esse cenário no quadro de saúde.

### 3.1.2 Análises Bivariadas

A primeira análise bivariada busca compreender a relação entre o resultado da radiografia e o estágio do tumor com a variável resposta (envolvimento nodal).

```{r}
library(gmodels)
library(epitab)

# X1 e X2 vs X4
tbl_contingencia<-amostra
tbl_contingencia$X1 <- ifelse(tbl_contingencia$X1==0,"Negativo","Positivo")
tbl_contingencia$X4 <- ifelse(tbl_contingencia$X4==0,"Sim","Nao")
tbl_contingencia$X2 <- ifelse(tbl_contingencia$X2==0,"Menos grave","Mais grave")
tbl_contingencia$X4 <- factor(tbl_contingencia$X4,levels=c("Sim","Nao"))
tbl_contingencia$X1 <-factor(tbl_contingencia$X1,levels=c("Negativo","Positivo"))
tbl_contingencia$X2 <- factor(tbl_contingencia$X2,levels=c("Menos grave",
                                                           "Mais grave"))

# tabela contingencia (formato de saída do SAS)
contingency_table(
  independents = list("Resultado radiografia"="X1","Estagio do tumor"="X2"),
  outcomes = list("Envolvimento nodal"="X4"),
  crosstab_funcs = list(freq()),
  row_funcs = list("Odds"=odds_ratio("X4")),
  data=tbl_contingencia) %>%
  neat_table(
    format = 'latex',
    booktabs=TRUE,
    caption="Frequências de envolvimento nodal por resultado da radiografia e estágio do tumor"
  ) %>%
  kableExtra::kable_classic(latex_options = "HOLD_position")
```

Nota-se pela tabela de contingência que a grande maioria dos pacientes com envolvimento nodal tiveram o resultado da radiografia negativo (86,7%). Por outro lado, dentre os indivíduos sem envolvimento nodal, 52,4% teve o resultado da radiografia positivo. Esses percentuais indicam uma possível associação entre as variáveis, o que também fica evidenciado pela razão de chances: a chance de um paciente com resultado da radiografia negativo ter envolvimento nodal é 7,15 vezes a chance de um paciente com resultado da radiografia positivo.

Já em relação ao estágio do tumor, a tabela revela que dentre os pacientes com envolvimento nodal, 65% apresentam estágio de tumor menos grave. Já entre os pacientes sem envolvimento nodal o cenário é oposto: 81% estão com um estágio de tumor mais grave. O valor da razão de chances indica que a chance de que um paciente com estágio de tumor menos grave tenha envolvimento nodal é 7,89 vezes a chance de um paciente com estágio do tumor mais grave.

Assim, para confirmar a relação entre essas variáveis, foi feito o teste qui-quadrado de independência:

```{r}
# teste correlação 
# testes de associacao qui-quadrado  
bivariadas<-amostra
names(bivariadas)<-c("ID","Resultado da radiografia",
                     "Estágio do tumor","Nível de fosfatase ácida",
                     "Envolvimento nodal")
bivariadas$`Envolvimento nodal`<- as.factor(bivariadas$`Envolvimento nodal`)
teste_radiog <- chisq.test(bivariadas$`Resultado da radiografia`,
                           bivariadas$`Envolvimento nodal`)
teste_tumor <- chisq.test(bivariadas$`Estágio do tumor`,
                          bivariadas$`Envolvimento nodal`)
# tabela p-valores
# teste_radiog$p.value<0.0001 #TRUE
# teste_tumor$p.value<0.0001  #TRUE
tbl_teste <- data.frame(
  "Variável"=c("Resultado da radiografia", "Estágio do tumor"),
  "Estatística do teste"=c(teste_radiog$statistic,teste_tumor$statistic),
  "Graus de liberdade"=c(teste_radiog$parameter, teste_tumor$parameter),
  "P-valor"=c("<0.0001","<0.0001"),
  check.names = F
)

tbl_teste %>%
  kableExtra::kbl(
    .,digits=3,align=c('l','c','c','c'),booktabs = T,
    caption = 'Testes Qui-Quadrado de independência com envolvimento nodal') %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")
```

Tendo em vista o baixo p-valor, rejeita-se a hipótese nula de independência entre o envolvimento nodal e o resultado da radiografia, assim como também rejeitamos a independência entre o envolvimento nodal e o estágio do tumor.

A seguir, obtém-se os gráficos e tabelas para análise da relação entre o nível de fosfatase ácida e o envolvimento nodal.


```{r}
# X3 vs X4
bivariadas$`Envolvimento nodal`<- ifelse(
  bivariadas$`Envolvimento nodal`==0,
  "Sim",
  "Não"
)

#Boxplot
ggplot(bivariadas,aes(x=`Envolvimento nodal`,y=`Nível de fosfatase ácida`)) +
  geom_boxplot(fill=c("#6E6DB8"),width=0.5) +
  stat_summary(fun.y="mean",geom="point",shape=23,size=3,fill="white") +
  labs(x="Envolvimento nodal",y="Nível de fosfatase ácida") +
  tema

# Tabela X3 vs X4
library(magrittr)
env_nodal <- amostra %>% filter(X4==0)
sem_env_nodal <- amostra %>% filter(X4==1)
tbl2 <- data.frame("Estatística"=c("Mínimo","1º Quartil",
                                   "Mediana","Média","3º Quartil",
                                   "Máximo","Desvio Padrão"),
                   "Sem envolvimento nodal"=c(summary(sem_env_nodal$X3),
                                              sd(sem_env_nodal$X3)),
                   "Com envolvimento nodal"=c(summary(env_nodal$X3),
                                              sd(env_nodal$X3)),
                   check.names = F)
rownames(tbl2)<-NULL

tbl2 %>%
  kableExtra::kbl(
    .,digits=2,align=c('l','c','c'),booktabs = T,
    caption = 'Medidas resumo da fosfatase ácida por envolvimento nodal'
  ) %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")
```

Observamos que o nível de fosfatase é, em média, maior entre os pacientes sem envolvimento nodal. Além disso, os valores de mediana do nível de fosfatase também são consideravelmente maiores no grupo sem envolvimento nodal. Portanto, a princípio, não devemos descartar nenhuma das variáveis pré-operatórias, pois todas aparentam ter uma relação com o envolvimento nodal dos indivíduos estudados.


\newpage

## 3.2 Modelagem

### 3.2.1 Regressão Logística Simples
<!-- Regressão Logística Simples -->

Primeiro deseja-se avaliar especificamente o efeito do nível de fosfatase ácida na predição para envolvimento nodal.

```{r,fig.width=8,out.width = '80%'}
treinamento %>% ggplot(aes(x=X3, y=X4)) + 
  geom_point() + 
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = FALSE, color="#6E6DB8", size=0.6) +
  labs(y="Envolvimento nodal",x="Nível de fosfatase ácida") +
  tema
```

O envolvimento nodal ocorre com maior frequência em níveis de fosfatase ácida mais baixos, mas apresenta alguns valores extremos como indicados na seção anterior. Como o envolvimento nodal assume apenas os valores 0 e 1, é difícil determinar a partir do gráfico de dispersão se o modelo é apropriado.

```{r}
log_simples <- glm(X4 ~ X3, family=binomial, data=treinamento)
summary(log_simples)
```

```{r}
confint(log_simples) # profile likelihood confidence interval
```


O modelo de regressão logística ajustado para a probabilidade $\pi(x)$ do paciente *não* apresentar envolvimento nodal em câncer de próstata é descrito a seguir.

$$\text{logito}[\hat{\pi}(x)] = -2.30638 + 0.03035x$$
Observe que para o teste de razão de verossimilhança rejeitamos a hipótese de independência da probabilidade de não envolvimento nodal em relação ao nível de fosfatase ácida ($\hat{\beta}_1 = 0$), para um nível de significância $\alpha=5\%$. Assim também, a estatística de razão de verossimilhança é de 5.605 e o p-valor aproximadamente 0.018, isto é, existem evidências de que a probabilidade não é idêntica para todos os níveis de fosfatase ácida, a um nível de significância $\alpha=5\%$.

Note que, $\hat{\beta}_1$ é positivo, então a probabilidade estimada é maior quanto maior o nível de fosfatase ácida. No nível mínimo, 40 na amostra selecionada para o ajuste, a probabilidade estimada de não envolvimento nodal é de 0.251 e no nível máximo é de 0.967. Assim, o efeito da fosfatase ácida é relativamente forte considerando a diferença entre os valores estimados para o mínimo e o máximo da amostra.

No ponto em que cada resultado tem 50% de probabilidade, o nível de fosfatase ácida é de 76 aproximadamente. Por outro lado, para o valor médio de 70.47, a probabilidade é de 0.458. 

Por último, a chance estimada para $\hat{\beta}_1$ é multiplicada por 1.03 para cada unidade adicionada de fosfatase ácida, ou seja, um aumento de 3%.


```{r}
lp <- predict(log_simples, newdata=validacao, se.fit=TRUE) # preditor linear
prob_preditas <- exp(lp$fit)/(1 + exp(lp$fit))
LB <- lp$fit - qnorm(0.975)*lp$se.fit
UB <- lp$fit + qnorm(0.975)*lp$se.fit
LB_p <- exp(LB)/(1 + exp(LB)) 
UB_p <- exp(UB)/(1 + exp(UB))

tabela_preditos <- tibble(
  X3=validacao$X3,
  prob_preditas = prob_preditas,
  LB_p = LB_p,
  UB_p = UB_p
)
```

```{r}
validacao %>% ggplot(aes(x=X3, y=X4)) + 
  geom_point() +
  geom_line(data=tabela_preditos, 
            aes(x=X3, y=prob_preditas), 
            color="#6E6DB8", size=0.6) +
  geom_line(data=tabela_preditos,
            aes(x=X3, y=LB_p), 
            color="#F1A661", size=0.6,
            linetype = "dashed") +
  geom_line(data=tabela_preditos, 
            aes(x=X3, y=UB_p), 
            color="#F1A661", size=0.6,
            linetype = "dashed") +
  labs(y="Envolvimento nodal",x="Nível de fosfatase ácida") +
  tema
```

Verifica-se o ajuste por meio do teste de Hosmer-Lemeshow.

```{r}
library(kableExtra)
library(ResourceSelection)
hoslem_test_resultado <- hoslem.test(log_simples$y, fitted(log_simples), g=10)

hl_df <- tibble(obs=hoslem_test_resultado$observed[,2], 
                esp=hoslem_test_resultado$expected[,2]) %>%
  mutate(grupo=seq(1,10)) %>% select(grupo,obs,esp)

hl_df %>% 
  kableExtra::kbl(.,digits=2,align=c('l','c'),booktabs = T,
                  caption = 'Teste Hosmer-Lemeshow',
                  col.names = c("Grupo","Observado","Esperado")) %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")
```


```{r}
hoslem_test_resultado
```

O p-valor indica que existem evidências para rejeitar a hipótese de ajuste do modelo a um nível de significância $\alpha=5\%$.

### 3.2.2 Regressão Logística Múltipla

<!-- Regressão Logística Múltipla -->

Na segunda etapa do estudo considera-se, além da variável nível de fosfatase ácida, as outras variáveis pré-operatórias e suas interações. Neste sentido, para a seleção das variáveis do modelo considera-se os critérios AIC e BIC, combinando os métodos stepwise "Forward selection" e "Backward elimination".

```{r}
log_multipla <- glm(X4 ~ X3 + factor(X1) + factor(X2) +
                      X3*factor(X1) + X3*factor(X2) + factor(X1)*factor(X2) +
                      X3*factor(X1)*factor(X2),
                    family=binomial, data=treinamento)
```

```{r}
library(MASS)
log_multipla_AIC <- log_multipla %>% stepAIC(trace = F, direction="both")
```

<!-- PRECISO DE ALGUM STEPAIC CORRIGIDO QUE TEM PRINT DOS STEPSSSSS, PORQUE ESSE AIC CANALHA PARA NO MINIMO LOCAL -->

```{r}
library(magrittr)
formatar_explicativas_modelo = function(formula) {
  formula %>%
    {as.character(.)[3]} %>%
    str_remove_all("factor\\(|\\)") %>%
    str_replace_all(":", '*') %>%
    str_replace_all(" \\* ","*")%>%
    str_replace_all(" \\+ ","+")
}
log_multipla_BIC_nula = glm(X4~., family=binomial, data=treinamento)

ajustes_modelos <- log_multipla_BIC_nula %$% tibble(
  Modelo = 0,
  "Fórmula" = "Null",
  Deviance = null.deviance,
  "g.l." = "",
  BIC = BIC(.),
  AIC = aic,
  "P-valor" = "",
)
for (step in 0:4) {
  log_multipla_BIC <- log_multipla %>% stepAIC(
    trace = F, direction="both", k=log(51), step=step
  )
  
  ajustes_modelos %<>% bind_rows(log_multipla_BIC %$% tibble(
    Modelo = step+1,
    "Fórmula" = formatar_explicativas_modelo(formula),
    Deviance = deviance,
    "g.l." = (df.null - df.residual) %>% as.character,
    AIC = aic,
    BIC = BIC(.),
    "P-valor" = ifelse(
      1 - pchisq((null.deviance - deviance), (df.null - df.residual)) < 0.001,
      "< 0.001",
      round(pvalor, 3)
    ),
  )
  )
}
log_multipla_BIC_mais_simples <- glm(X4 ~ factor(X1) + factor(X2),
                                     family=binomial,
                                     data=treinamento)
ajustes_modelos %<>% bind_rows(
  log_multipla_BIC_mais_simples %$% tibble(
    Modelo = step+1,
    "Fórmula" = formatar_explicativas_modelo(formula),
    Deviance = deviance,
    "g.l." = (df.null - df.residual) %>% as.character,
    AIC = aic,
    BIC = BIC(.),
    "P-valor" = ifelse(
      1 - pchisq((null.deviance - deviance), (df.null - df.residual)) < 0.001,
      "< 0.001",
      round(pvalor, 3)
    ),
  )
)
ajustes_modelos$Modelo <- 0:6
ajustes_modelos %>%
  kableExtra::kbl(digits=2,align=c('l','l','l','l','l','l','l'),booktabs = T,
                  caption = 'Medidas de ajuste dos modelos') %>% 
  kableExtra::kable_classic(full_width=F,latex_options = "HOLD_position")
```

Os métodos de seleção automática de variáveis, AIC e BIC, identificaram o modelo 5 como mais adequado. O resto dos modelos foram apresentados para facilitar a comparação e justificar a seleção dos 3 modelos candidatos. O modelo 6, que tem o menor número de parâmetros e que apresentou valores ligeriamente superiores de AIC e BIC quando comparado com o modelo 5, foi considerado pelo critério da interpretabilidade.

Como todos os modelos são signifcativos para o teste de ausência de regressão, então selecionamos os dois que tiveram melhor desempenho para o AIC e o BIC (modelo 4 e 5). Além disso, considera-se a interpretabilidade como outro fator importante para seleção dos modelos e, portanto, o modelo 6 também é separado como candidato. Assim, Os modelos ajustados são descritos a seguir.

$$\text{logito}[\hat{\pi}(x)] = -4.59733 + 0.02462x_1 - 2.96608x_2 + 2.89812x_3 + 0.08951x_1x_2$$

$$\text{logito}[\hat{\pi}(x)] = -5.41499 + 0.03323x_1 + 2.80120x_2 + 3.13819x_3$$

$$\text{logito}[\hat{\pi}(x)] = -2.5888 + 2.7833x_2 + 2.5243x_3$$

Para os dois últimos modelos, assume-se que não existe interação entre nível de fofatase ácida e estágio do tumor ou nível de fofatase ácida e resultado da radiografia ou estágio do tumor e resultado da radiografia.


```{r}
modelo_final_mais_complexo <- glm(
  X4 ~ X3 + factor(X1) + factor(X2) + X3*factor(X1),
  family=binomial,
  data=treinamento
)
modelo_final_complexo <- glm(X4 ~ X3 + factor(X1) + factor(X2),
                             family=binomial,
                             data=treinamento)
modelo_final_simples <- glm(X4 ~ factor(X1) + factor(X2),
                            family=binomial,
                            data=treinamento)
```


<!-- TESTE DE AJUSTAMENTO -->

A continuação calculamos os testes de ajuste do modelo. Note que, para o modelo com variável quantitativa contínua utilizamos o teste de Hosmer-Lemeshow.

O teste indica que existem evidências de ajustamento para os modelos de 3 e 4 parâmetros (p-valor de 0.7014 e 0.6480, respectivamente). Por outro lado, para o modelo mais complexo observamos pior desempenho no ajuste (pvalor = 0.106).

A continuação apresentamos as tabelas para os valores observados e esperados considerados no teste de Hosmer-Lemeshow.

```{r}
library(ResourceSelection)

# teste para modelo mais complexo (com variável continua)
hoslem_test_resultado <- hoslem.test(
  modelo_final_mais_complexo$y,
  fitted(modelo_final_mais_complexo),
  g=10
)

hl_df <- tibble(obs=hoslem_test_resultado$observed[,2], 
                esp=hoslem_test_resultado$expected[,2]) %>%
  mutate(grupo=seq(1,10)) %>% dplyr::select(grupo,obs,esp)

hl_df %>% 
  kableExtra::kbl(
    .,digits=2,align=c('l','c'),booktabs = T,
    caption = 'Teste Hosmer-Lemeshow para o modelo de 4 parâmetros e 1 interação',
    col.names = c("Grupo","Observado","Esperado")
  ) %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")
```


```{r}
# teste para modelo complexo (com variável continua)
hoslem_test_resultado <- hoslem.test(modelo_final_complexo$y,
                                     fitted(modelo_final_complexo), g=10)

hl_df <- tibble(obs=hoslem_test_resultado$observed[,2], 
                esp=hoslem_test_resultado$expected[,2]) %>%
  mutate(grupo=seq(1,10)) %>% dplyr::select(grupo,obs,esp)

hl_df %>% 
  kableExtra::kbl(
    .,digits=2,align=c('l','c'),booktabs = T,
    caption = 'Teste Hosmer-Lemeshow para o modelo de 4 parâmetros',
    col.names = c("Grupo","Observado","Esperado")
  ) %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")
```


<!-- COMENTAR Matriz de confusão -->

O desempenho do poder preditivo é analisado a partir da acurácia dos modelos e o gráfico de curvas ROC, considerando banco de validação. O limite de decisão definido é de 0.5.

```{r}
library(caret)
tabela_acuracia <- tibble(modelo = rep(NA,3), acuracia = rep(NA,3))

probabs_preditas <- list(
  predict(modelo_final_mais_complexo, newdata = validacao,type = "response"),
  predict(modelo_final_complexo, newdata = validacao,type = "response"),
  predict(modelo_final_simples, newdata = validacao,type = "response")
)


modelos <- c(formatar_explicativas_modelo(modelo_final_mais_complexo$formula),
             formatar_explicativas_modelo(modelo_final_complexo$formula),
             formatar_explicativas_modelo(modelo_final_simples$formula))

validacao$X4 <- as.factor(validacao$X4)

for(i in 1:3){
  
  truth_predicted <- data.frame(
    obs = validacao$X4,
    pred = factor(as.vector(ifelse(probabs_preditas[[i]] > .5, 1, 0)))
  )
  
  tabela_acuracia$modelo[i] <- modelos[i]
  tabela_acuracia$acuracia[i] <-confusionMatrix(
    truth_predicted$pred,
    validacao$X4
  )$overall[1]
}

tabela_acuracia %>% 
  kableExtra::kbl(.,digits=2,align=c('l','c'),booktabs = T,
                  caption = 'Acurácia observada nos modelos candidatos',
                  col.names = c("Modelo","Acurácia")) %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")
```


```{r}
library(pROC)

cowplot::plot_grid(
  ggroc(roc(treinamento$X4, fitted(modelo_final_mais_complexo)), colour='red') +
    geom_abline(intercept = 1, slope=1, alpha=.3) +
    labs(title="Modelo de 4 parâmetros + 1 interação")+
    tema,
  ggroc(roc(treinamento$X4, fitted(modelo_final_complexo)), colour='red') +
    geom_abline(intercept = 1, slope=1, alpha=.3) +
    labs(title="Modelo de 4 parâmetros")+
    tema,
  ggroc(roc(treinamento$X4, fitted(modelo_final_simples)), colour='red') +
    geom_abline(intercept = 1, slope=1, alpha=.3) +
    labs(title="Modelo de 3 parâmetros")+
    tema
)
```

<!-- O modelo mais complexo é superior (AUC é maior) COMENTAR  -->

Para um valor particular de especificidade, o melhor poder preditivo corresponde a uma maior sensibilidade, isto significa, quanto maior a área melhor o poder preditivo. Assim, o modelo com 4 parâmetros apresenta o melhor desempenho se considerarmos o AUC de 0.84, seguido do modelo com uma interação e por último o modelo de 3 parâmetros.

Os resultados observados na curva ROC são condizentes com os da tabela de valores da acurácia para cada modelo.

<!-- ANALISE DE RESIDUOS PADRONIZADOS -->

```{r}
res_padronizado_1 <- tibble(
  index=seq(1,51),
  residuos=rstandard(modelo_final_mais_complexo, type='deviance')
) %>%
  ggplot(aes(x=index, y=residuos)) +
  geom_point() +
  labs(title="Modelo de 4 parâmetros e 1 interação ")+
  geom_hline(yintercept = 0, color="orange") +
  tema

res_padronizado_2 <- tibble(
  index=seq(1,51),
  residuos=rstandard(modelo_final_complexo, type='deviance')
) %>%
  ggplot(aes(x=index, y=residuos)) +
  labs(title="Modelo de 4 parâmetros")+
  geom_point() +
  geom_hline(yintercept = 0, color="orange") +
  tema

res_padronizado_3 <- tibble(
  index=seq(1,51),
  residuos=rstandard(modelo_final_simples, type='deviance')
) %>%
  ggplot(aes(x=index, y=residuos)) +
  geom_point() +
  labs(title="Modelo de 3 parâmetros") +
  geom_hline(yintercept = 0, color="orange") +
  tema


library(cowplot)
cowplot::plot_grid(res_padronizado_1,res_padronizado_2,res_padronizado_3,nrow=2)
```

Observamos dos gráficos que o comportamento dos resíduos é bastante estável em todos os modelos. Não existem outliers drasticamente distantes do eixo 0, estando a maioria concentrados entre -1 e 1 e poucos para além de -2 e 2, especialmente nos modelos de dois e três parâmetros.


### 3.2.3 Modelo final

Tendo em vista os valores de acurácia no banco de validação, o gráfico da curva ROC e o critério de parcimônia, ficou clara a escolha pelo modelo com todas as variáveis, sem interações. Tal modelo será ajustado no banco de dados completo, a seguir.

```{r}
# formula = X4 ~ X3 + factor(X1) + factor(X2)
modelo_no_banco_completo <- glm(X4 ~ X3 + factor(X1) + factor(X2),
                                family=binomial,
                                data=amostra)

summary(modelo_no_banco_completo)
```

É possível observar, pela saída do modelo final, que rejeitamos a hipótese nula de que os parâmetros do modelo são nulos, para todas as variáveis selecionadas, levando em consideração os baixos p-valores obtidos no teste Z e o nível de significância adotado ($\alpha=5\%$). A interpretação dos coeficientes estimados pode ser vista por meio da tabela abaixo.


```{r}
# Intevalos para os parametros (95%)

z <- qnorm(0.975)
b1 <- modelo_no_banco_completo$coefficients[3]
b2 <- modelo_no_banco_completo$coefficients[4]
b3<- modelo_no_banco_completo$coefficients[2]
ASE1 <- summary(modelo_no_banco_completo)$coefficients[3,2]
ASE2 <- summary(modelo_no_banco_completo)$coefficients[4,2]
ASE3 <- summary(modelo_no_banco_completo)$coefficients[2,2] 
# b1
b1_ic <- c(b1-z*ASE1,b1+z*ASE1)
b1_ic_string <- paste("[",round(b1_ic[1],2),",",round(b1_ic[2],2),"]")
# b2
b2_ic <- c(b2-z*ASE2,b2+z*ASE2)
b2_ic_string <- paste("[",round(b2_ic[1],2),",",round(b2_ic[2],2),"]")

# b3
b3_ic <- c(b3-z*ASE3,b3+z*ASE3)
b3_ic_string <- paste("[",round(b3_ic[1],2),",",round(b3_ic[2],2),"]")


# Intervalos para odds

odds_b1 <- exp(b1_ic)
odds_b1_string <- paste("[",round(odds_b1[1],2),",",round(odds_b1[2],2),"]")
odds_b2 <- exp(b2_ic)
odds_b2_string <- paste("[",round(odds_b2[1],2),",",round(odds_b2[2],2),"]")
odds_b3 <- exp(b3_ic)
odds_b3_string <- paste("[",round(odds_b3[1],2),",",round(odds_b3[2],2),"]")

tbl_intervalos_betas_odds <- data.frame(
  "Coeficiente"=c("Beta 1","Beta 2","Beta 3"),
  "Intervalo do coeficiente"=c(b1_ic_string,
                               b2_ic_string,
                               b3_ic_string),
  "Odds"=c(exp(b1),exp(b2),exp(b3)),
  "Intervalo da Odds"=c(odds_b1_string,
                        odds_b2_string,
                        odds_b3_string),
  check.names = F
)
rownames(tbl_intervalos_betas_odds)<-NULL
tbl_intervalos_betas_odds %>% 
  kableExtra::kbl(
    .,digits=3,align=c('l','c','c','c'),booktabs = T,
    caption = 'Intervalos de confiança (95\\%) para o modelo final') %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")
```

O coeficiente $\hat{\beta_1}$, que acompanha a variável resultado da radiografia, indica que, mantendo todo o restante constante, o resultado positivo representa de 3,67 até 65,7 vezes a chance de **não** ter envolvimento nodal, em comparação com o resultado negativo. Já o coeficiente $\hat{\beta_2}$, que acompanha a variável estágio do tumor, indica que, dado todo o restante constante, o estágio de tumor mais grave representa de 5,64 até 108,5 vezes a chance de **não** ter o quadro de envolvimento nodal, em comparação com o estágio de tumor menos grave. Por fim, o parâmetro $\hat{\beta_3}$, referente ao nível de fosfatase ácida, revela que o incremento de 1 unidade (na escala x100) na fosfatase acarreta em um aumento multiplicativo na chance de **não** ter envolvimento nodal de 1,01 até 1,05, isto é, de 1% até 5%.

Por fim, segue o gráfico das curvas do modelo ajustado para cada combinação das variáveis categóricas (estágio do tumor e resultado da radiografia):
```{r,fig.width=8,out.width = '80%'}
pontos_x3 = seq(from=0, to=max(amostra$X3), by=0.01)
B0 = modelo_final_complexo$coefficients[1]
B1_X3 = modelo_final_complexo$coefficients[2]
B2_X1 = modelo_final_complexo$coefficients[3]
B3_X2 = modelo_final_complexo$coefficients[4]

map_df(0:1, function(x1_dummy) {
  map_df(0:1, function(x2_dummy) {
    tibble(
      x1=x1_dummy,
      x2=x2_dummy,
      grupo=str_c("(X1=",x1,", X2=",x2, ")"),
      x3=pontos_x3,
      logito=B0 + B1_X3*x3 + B2_X1*x1 + B3_X2*x2,
      prob=exp(logito)/(1 + exp(logito)),
    )
  })
}) %>%
  ggplot() +
  geom_path(aes(x=x3, y=prob, color=grupo, group=grupo))+ theme_bw()
```

\newpage

# 4. Conclusão

O presente estudo propôs identificar fatores que acarretam no envolvimento nodal de pacientes com câncer de próstata, e nas relações desses fatores com a probabilidade de não apresentar envolvimento. Desse modo, as análises exploratórias indicaram que todas as variáveis, resultado da radiografia, estágio do tumor e nível de fosfatase ácida apresentavam algum tipo de relação com a variável resposta. Seguindo para a modelagem, a regressão logística simples (apenas com a fosfatase ácida) se mostrou insatisfatória, não sendo capaz de explicar com êxito o envolvimento nodal dos indivíduos.

Desta forma, foi aplicado o procedimento de regressão logística múltipla, onde todas as variáveis da amostra foram consideradas. A etapa de escolha das variáveis indicou o modelo com todos os fatores (simples, sem interações) como sendo o mais pertinente, dado os valores de AIC, testes de ajustamento, curva ROC e valores de acurácia obtidos por meio da partição do banco que foi destinada para validação. Assim, o modelo escolhido apresentou resultados satisfatórios, e podemos dizer que é capaz de predizer a não ocorrência de envolvimento nodal, dado as variáveis pré-operatorias, com um erro razoável. Certamente o erro de predição poderia ser atenuado por meio de novos estudos, com maior número de indivíduos amostrados e coleta de novas variáveis.

De modo geral, o resultado da radiografia negativo impactou positivamente na probabilidade de haver envolvimento nodal, assim como o estágio de tumor menos grave também parece gerar impacto significativo no aumento dessa probabilidade. Em relação ao nível de fosfatase ácida, apesar de ser maior, em média, em pacientes sem envolvimento nodal, os valores discrepantes presentes no grupo que possui envolvimento nodal podem ter repercurtido e afetado o modelo final. De todo modo, o aumento de uma unidade no nível de fosfatase indicou um aumento multiplicativo na chance de não ter envolvimento nodal de até 5%.


\newpage

# 5. Apêndice

```{r, eval=F, echo=T}

# Carregar os dados
library(readxl)
library(tidyverse)
setwd(getwd())

amostra <- read_xlsx(path="Amostra_g06.xlsx",
                     sheet = "Amostra_g06")

# Seleciona a amostra n=51
set.seed(12345)
rows_index <- sample(1:nrow(amostra),51)
treinamento <- amostra[rows_index,]
validacao <- amostra[-rows_index,]

#Define o tema dos gráficos
tema <- theme_bw()+
  theme(axis.title.y=element_text(colour="black", size=14),
        axis.title.x = element_text(colour="black", size=14),
        axis.text = element_text(colour = "black", size=14),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        plot.title = element_text(hjust = 0.5, size=12),
        legend.position = "bottom",
        legend.text=element_text(size=18))

# X1 - Resultado da radiografia
# 0 – negativo 1 – positivo

Fr <- table(amostra$X1)
Pr <- as.data.frame(round(prop.table(Fr) , digits=4 ) * 100 )
colnames(Pr)<-c("Var1","Pr" )
comp <- merge(Fr,Pr, by= "Var1" )
comp$Pr<-paste(gsub( "\\." , "," ,comp$Pr ) , "%" , sep="")
comp$Var1 <- c("Negativo","Positivo")

# Grafico barras
ggplot(comp,aes(x=Var1,y=Freq,label=Pr))+
  geom_bar(stat="identity",fill="#6E6DB8")+
  geom_text(vjust=-0.5,size=4)+
  labs(x="Resultado da radiografia",y="Frequência Absoluta")+
  tema

# X2 - Estágio do tumor
# 0 – menos grave ou 1 – mais grave
Fr <- table(amostra$X2)
Pr <- as.data.frame(round(prop.table(Fr) , digits=4 ) * 100 )
colnames(Pr)<-c("Var1","Pr" )
comp <- merge(Fr,Pr, by= "Var1" )
comp$Pr<-paste(gsub( "\\." , "," ,comp$Pr ) , "%" , sep="")
comp$Var1 <- c("Menos grave","Mais grave")

# Grafico barras
ggplot(comp,aes(x=Var1,y=Freq,label=Pr))+
  geom_bar(stat="identity",fill="#6E6DB8")+
  geom_text(vjust=-0.5,size=4)+
  labs(x="Estágio do tumor",y="Frequência Absoluta")+
  tema

# X3 - Nível de fosfatase ácida

# Boxplot

ggplot(amostra, aes(x=factor(""), y=X3)) +
  geom_boxplot(fill=c("#6E6DB8"),width=0.5) +
  guides(fill=FALSE) +
  stat_summary(fun.y="mean",geom="point",shape=23,size=3,
               fill="white") +
  labs(x="",y="Nível de fosfatase ácida") +
  tema

# Tabela medidas resumo
library(kableExtra)

summaryX3 <- summary(amostra$X3)

tbl1 <- data.frame("Estatística"=c("Mínimo","1º Quartil",
                                   "Mediana","Média","3º Quartil",
                                   "Máximo","Desvio Padrão"),
                   "Valor"=c(summaryX3,sd(amostra$X3)),
                   check.names = F)

rownames(tbl1)<-NULL

tbl1 %>%
  kableExtra::kbl(.,digits=2,align=c('l','c'),booktabs = T,
                  caption = 'Medidas resumo do nível de fosfatase ácida') %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")

# X4 - Envolvimento nodal
# 0 – sim 1 – não

Fr <- table(amostra$X4)
Pr <- as.data.frame(round(prop.table(Fr) , digits=4 ) * 100 )
colnames(Pr)<-c("Var1","Pr" )
comp <- merge(Fr,Pr, by= "Var1" )
comp$Pr<-paste(gsub( "\\." , "," ,comp$Pr ) , "%" , sep="")
comp$Var1 <- c("Sim","Não")

# Grafico barras
ggplot(comp,aes(x=Var1,y=Freq,label=Pr))+
  geom_bar(stat="identity",fill="#6E6DB8")+
  geom_text(vjust=-0.5,size=4)+
  labs(x="Envolvimento nodal",y="Frequência Absoluta")+
  tema

library(gmodels)
library(epitab)

# X1 e X2 vs X4
tbl_contingencia<-amostra
tbl_contingencia$X1 <- ifelse(tbl_contingencia$X1==0,"Negativo","Positivo")
tbl_contingencia$X4 <- ifelse(tbl_contingencia$X4==0,"Sim","Nao")
tbl_contingencia$X2 <- ifelse(tbl_contingencia$X2==0,"Menos grave","Mais grave")
tbl_contingencia$X4 <- factor(tbl_contingencia$X4,levels=c("Sim","Nao"))
tbl_contingencia$X1 <-factor(tbl_contingencia$X1,levels=c("Negativo","Positivo"))
tbl_contingencia$X2 <- factor(tbl_contingencia$X2,levels=c("Menos grave",
                                                           "Mais grave"))

# tabela contingencia (formato de saída do SAS)
contingency_table(
  independents = list("Resultado radiografia"="X1","Estagio do tumor"="X2"),
  outcomes = list("Envolvimento nodal"="X4"),
  crosstab_funcs = list(freq()),
  row_funcs = list("Odds"=odds_ratio("X4")),
  data=tbl_contingencia) %>%
  neat_table(
    format = 'latex',
    booktabs=TRUE,
    caption="Frequências de envolvimento nodal por resultado da radiografia e estágio do tumor"
  ) %>%
  kableExtra::kable_classic(latex_options = "HOLD_position")

# teste correlação 
# testes de associacao qui-quadrado  
bivariadas<-amostra
names(bivariadas)<-c("ID","Resultado da radiografia",
                     "Estágio do tumor","Nível de fosfatase ácida",
                     "Envolvimento nodal")
bivariadas$`Envolvimento nodal`<- as.factor(bivariadas$`Envolvimento nodal`)
teste_radiog <- chisq.test(bivariadas$`Resultado da radiografia`,
                           bivariadas$`Envolvimento nodal`)
teste_tumor <- chisq.test(bivariadas$`Estágio do tumor`,
                          bivariadas$`Envolvimento nodal`)
# tabela p-valores
# teste_radiog$p.value<0.0001 #TRUE
# teste_tumor$p.value<0.0001  #TRUE
tbl_teste <- data.frame(
  "Variável"=c("Resultado da radiografia", "Estágio do tumor"),
  "Estatística do teste"=c(teste_radiog$statistic,teste_tumor$statistic),
  "Graus de liberdade"=c(teste_radiog$parameter, teste_tumor$parameter),
  "P-valor"=c("<0.0001","<0.0001"),
  check.names = F
)

tbl_teste %>%
  kableExtra::kbl(
    .,digits=3,align=c('l','c','c','c'),booktabs = T,
    caption = 'Testes Qui-Quadrado de independência com envolvimento nodal') %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")

# X3 vs X4
bivariadas$`Envolvimento nodal`<- ifelse(
  bivariadas$`Envolvimento nodal`==0,
  "Sim",
  "Não"
)

#Boxplot
ggplot(bivariadas,aes(x=`Envolvimento nodal`,y=`Nível de fosfatase ácida`)) +
  geom_boxplot(fill=c("#6E6DB8"),width=0.5) +
  stat_summary(fun.y="mean",geom="point",shape=23,size=3,fill="white") +
  labs(x="Envolvimento nodal",y="Nível de fosfatase ácida") +
  tema

# Tabela X3 vs X4
library(magrittr)
env_nodal <- amostra %>% filter(X4==0)
sem_env_nodal <- amostra %>% filter(X4==1)
tbl2 <- data.frame("Estatística"=c("Mínimo","1º Quartil",
                                   "Mediana","Média","3º Quartil",
                                   "Máximo","Desvio Padrão"),
                   "Sem envolvimento nodal"=c(summary(sem_env_nodal$X3),
                                              sd(sem_env_nodal$X3)),
                   "Com envolvimento nodal"=c(summary(env_nodal$X3),
                                              sd(env_nodal$X3)),
                   check.names = F)
rownames(tbl2)<-NULL

tbl2 %>%
  kableExtra::kbl(
    .,digits=2,align=c('l','c','c'),booktabs = T,
    caption = 'Medidas resumo da fosfatase ácida por envolvimento nodal'
  ) %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")

treinamento %>% ggplot(aes(x=X3, y=X4)) + 
  geom_point() + 
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial"), 
              se = FALSE, color="#6E6DB8", size=0.6) +
  labs(y="Envolvimento nodal",x="Nível de fosfatase ácida") +
  tema


log_simples <- glm(X4 ~ X3, family=binomial, data=treinamento)
summary(log_simples)

confint(log_simples) # profile likelihood confidence interval

lp <- predict(log_simples, newdata=validacao, se.fit=TRUE) # preditor linear
prob_preditas <- exp(lp$fit)/(1 + exp(lp$fit))
LB <- lp$fit - qnorm(0.975)*lp$se.fit
UB <- lp$fit + qnorm(0.975)*lp$se.fit
LB_p <- exp(LB)/(1 + exp(LB)) 
UB_p <- exp(UB)/(1 + exp(UB))

tabela_preditos <- tibble(
  X3=validacao$X3,
  prob_preditas = prob_preditas,
  LB_p = LB_p,
  UB_p = UB_p
)

validacao %>% ggplot(aes(x=X3, y=X4)) + 
  geom_point() +
  geom_line(data=tabela_preditos, 
            aes(x=X3, y=prob_preditas), 
            color="#6E6DB8", size=0.6) +
  geom_line(data=tabela_preditos,
            aes(x=X3, y=LB_p), 
            color="#F1A661", size=0.6,
            linetype = "dashed") +
  geom_line(data=tabela_preditos, 
            aes(x=X3, y=UB_p), 
            color="#F1A661", size=0.6,
            linetype = "dashed") +
  labs(y="Envolvimento nodal",x="Nível de fosfatase ácida") +
  tema

library(kableExtra)
library(ResourceSelection)
hoslem_test_resultado <- hoslem.test(log_simples$y, fitted(log_simples), g=10)

hl_df <- tibble(obs=hoslem_test_resultado$observed[,2], 
                esp=hoslem_test_resultado$expected[,2]) %>%
  mutate(grupo=seq(1,10)) %>% select(grupo,obs,esp)

hl_df %>% 
  kableExtra::kbl(.,digits=2,align=c('l','c'),booktabs = T,
                  caption = 'Teste Hosmer-Lemeshow',
                  col.names = c("Grupo","Observado","Esperado")) %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")

hoslem_test_resultado


log_multipla <- glm(X4 ~ X3 + factor(X1) + factor(X2) +
                      X3*factor(X1) + X3*factor(X2) + factor(X1)*factor(X2) +
                      X3*factor(X1)*factor(X2),
                    family=binomial, data=treinamento)

library(MASS)
log_multipla_AIC <- log_multipla %>% stepAIC(trace = F, direction="both")

library(magrittr)
formatar_explicativas_modelo = function(formula) {
  formula %>%
    {as.character(.)[3]} %>%
    str_remove_all("factor\\(|\\)") %>%
    str_replace_all(":", '*') %>%
    str_replace_all(" \\* ","*")%>%
    str_replace_all(" \\+ ","+")
}
log_multipla_BIC_nula = glm(X4~., family=binomial, data=treinamento)

ajustes_modelos <- log_multipla_BIC_nula %$% tibble(
  Modelo = 0,
  "Fórmula" = "Null",
  Deviance = null.deviance,
  "g.l." = "",
  BIC = BIC(.),
  AIC = aic,
  "P-valor" = "",
)
for (step in 0:4) {
  log_multipla_BIC <- log_multipla %>% stepAIC(
    trace = F, direction="both", k=log(51), step=step
  )
  
  ajustes_modelos %<>% bind_rows(log_multipla_BIC %$% tibble(
    Modelo = step+1,
    "Fórmula" = formatar_explicativas_modelo(formula),
    Deviance = deviance,
    "g.l." = (df.null - df.residual) %>% as.character,
    AIC = aic,
    BIC = BIC(.),
    "P-valor" = ifelse(
      1 - pchisq((null.deviance - deviance), (df.null - df.residual)) < 0.001,
      "< 0.001",
      round(pvalor, 3)
    ),
  )
  )
}
log_multipla_BIC_mais_simples <- glm(X4 ~ factor(X1) + factor(X2),
                                     family=binomial,
                                     data=treinamento)
ajustes_modelos %<>% bind_rows(
  log_multipla_BIC_mais_simples %$% tibble(
    Modelo = step+1,
    "Fórmula" = formatar_explicativas_modelo(formula),
    Deviance = deviance,
    "g.l." = (df.null - df.residual) %>% as.character,
    AIC = aic,
    BIC = BIC(.),
    "P-valor" = ifelse(
      1 - pchisq((null.deviance - deviance), (df.null - df.residual)) < 0.001,
      "< 0.001",
      round(pvalor, 3)
    ),
  )
)
ajustes_modelos$Modelo <- 0:6
ajustes_modelos %>%
  kableExtra::kbl(digits=2,align=c('l','l','l','l','l','l','l'),booktabs = T,
                  caption = 'Medidas de ajuste dos modelos') %>% 
  kableExtra::kable_classic(full_width=F,latex_options = "HOLD_position")


modelo_final_mais_complexo <- glm(
  X4 ~ X3 + factor(X1) + factor(X2) + X3*factor(X1),
  family=binomial,
  data=treinamento
)
modelo_final_complexo <- glm(X4 ~ X3 + factor(X1) + factor(X2),
                             family=binomial,
                             data=treinamento)
modelo_final_simples <- glm(X4 ~ factor(X1) + factor(X2),
                            family=binomial,
                            data=treinamento)

library(ResourceSelection)

# teste para modelo mais complexo (com variável continua)
hoslem_test_resultado <- hoslem.test(
  modelo_final_mais_complexo$y,
  fitted(modelo_final_mais_complexo),
  g=10
)

hl_df <- tibble(obs=hoslem_test_resultado$observed[,2], 
                esp=hoslem_test_resultado$expected[,2]) %>%
  mutate(grupo=seq(1,10)) %>% dplyr::select(grupo,obs,esp)

hl_df %>% 
  kableExtra::kbl(
    .,digits=2,align=c('l','c'),booktabs = T,
    caption = 'Teste Hosmer-Lemeshow para o modelo de 4 parâmetros e 1 interação',
    col.names = c("Grupo","Observado","Esperado")
  ) %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")


# teste para modelo complexo (com variável continua)
hoslem_test_resultado <- hoslem.test(modelo_final_complexo$y,
                                     fitted(modelo_final_complexo), g=10)

hl_df <- tibble(obs=hoslem_test_resultado$observed[,2], 
                esp=hoslem_test_resultado$expected[,2]) %>%
  mutate(grupo=seq(1,10)) %>% dplyr::select(grupo,obs,esp)

hl_df %>% 
  kableExtra::kbl(
    .,digits=2,align=c('l','c'),booktabs = T,
    caption = 'Teste Hosmer-Lemeshow para o modelo de 4 parâmetros',
    col.names = c("Grupo","Observado","Esperado")
  ) %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")

library(caret)
tabela_acuracia <- tibble(modelo = rep(NA,3), acuracia = rep(NA,3))

probabs_preditas <- list(
  predict(modelo_final_mais_complexo, newdata = validacao,type = "response"),
  predict(modelo_final_complexo, newdata = validacao,type = "response"),
  predict(modelo_final_simples, newdata = validacao,type = "response")
)


modelos <- c(formatar_explicativas_modelo(modelo_final_mais_complexo$formula),
             formatar_explicativas_modelo(modelo_final_complexo$formula),
             formatar_explicativas_modelo(modelo_final_simples$formula))

validacao$X4 <- as.factor(validacao$X4)

for(i in 1:3){
  
  truth_predicted <- data.frame(
    obs = validacao$X4,
    pred = factor(as.vector(ifelse(probabs_preditas[[i]] > .5, 1, 0)))
  )
  
  tabela_acuracia$modelo[i] <- modelos[i]
  tabela_acuracia$acuracia[i] <-confusionMatrix(
    truth_predicted$pred,
    validacao$X4
  )$overall[1]
}

tabela_acuracia %>% 
  kableExtra::kbl(.,digits=2,align=c('l','c'),booktabs = T,
                  caption = 'Acurácia observada nos modelos candidatos',
                  col.names = c("Modelo","Acurácia")) %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")

library(pROC)

cowplot::plot_grid(
  ggroc(roc(treinamento$X4, fitted(modelo_final_mais_complexo)), colour='red') +
    geom_abline(intercept = 1, slope=1, alpha=.3) +
    labs(title="Modelo de 4 parâmetros + 1 interação")+
    tema,
  ggroc(roc(treinamento$X4, fitted(modelo_final_complexo)), colour='red') +
    geom_abline(intercept = 1, slope=1, alpha=.3) +
    labs(title="Modelo de 4 parâmetros")+
    tema,
  ggroc(roc(treinamento$X4, fitted(modelo_final_simples)), colour='red') +
    geom_abline(intercept = 1, slope=1, alpha=.3) +
    labs(title="Modelo de 3 parâmetros")+
    tema
)

res_padronizado_1 <- tibble(
  index=seq(1,51),
  residuos=rstandard(modelo_final_mais_complexo, type='deviance')
) %>%
  ggplot(aes(x=index, y=residuos)) +
  geom_point() +
  labs(title="Modelo de 4 parâmetros e 1 interação ")+
  geom_hline(yintercept = 0, color="orange") +
  tema

res_padronizado_2 <- tibble(
  index=seq(1,51),
  residuos=rstandard(modelo_final_complexo, type='deviance')
) %>%
  ggplot(aes(x=index, y=residuos)) +
  labs(title="Modelo de 4 parâmetros")+
  geom_point() +
  geom_hline(yintercept = 0, color="orange") +
  tema

res_padronizado_3 <- tibble(
  index=seq(1,51),
  residuos=rstandard(modelo_final_simples, type='deviance')
) %>%
  ggplot(aes(x=index, y=residuos)) +
  geom_point() +
  labs(title="Modelo de 3 parâmetros") +
  geom_hline(yintercept = 0, color="orange") +
  tema


library(cowplot)
cowplot::plot_grid(res_padronizado_1,res_padronizado_2,res_padronizado_3,nrow=2)


# formula = X4 ~ X3 + factor(X1) + factor(X2)
modelo_no_banco_completo <- glm(X4 ~ X3 + factor(X1) + factor(X2),
                                family=binomial,
                                data=amostra)

summary(modelo_no_banco_completo)

# Intevalos para os parametros (95%)

z <- qnorm(0.975)
b1 <- modelo_no_banco_completo$coefficients[3]
b2 <- modelo_no_banco_completo$coefficients[4]
b3<- modelo_no_banco_completo$coefficients[2]
ASE1 <- summary(modelo_no_banco_completo)$coefficients[3,2]
ASE2 <- summary(modelo_no_banco_completo)$coefficients[4,2]
ASE3 <- summary(modelo_no_banco_completo)$coefficients[2,2] 
# b1
b1_ic <- c(b1-z*ASE1,b1+z*ASE1)
b1_ic_string <- paste("[",round(b1_ic[1],2),",",round(b1_ic[2],2),"]")
# b2
b2_ic <- c(b2-z*ASE2,b2+z*ASE2)
b2_ic_string <- paste("[",round(b2_ic[1],2),",",round(b2_ic[2],2),"]")

# b3
b3_ic <- c(b3-z*ASE3,b3+z*ASE3)
b3_ic_string <- paste("[",round(b3_ic[1],2),",",round(b3_ic[2],2),"]")


# Intervalos para odds

odds_b1 <- exp(b1_ic)
odds_b1_string <- paste("[",round(odds_b1[1],2),",",round(odds_b1[2],2),"]")
odds_b2 <- exp(b2_ic)
odds_b2_string <- paste("[",round(odds_b2[1],2),",",round(odds_b2[2],2),"]")
odds_b3 <- exp(b3_ic)
odds_b3_string <- paste("[",round(odds_b3[1],2),",",round(odds_b3[2],2),"]")

tbl_intervalos_betas_odds <- data.frame(
  "Coeficiente"=c("Beta 1","Beta 2","Beta 3"),
  "Intervalo do coeficiente"=c(b1_ic_string,
                               b2_ic_string,
                               b3_ic_string),
  "Odds"=c(exp(b1),exp(b2),exp(b3)),
  "Intervalo da Odds"=c(odds_b1_string,
                        odds_b2_string,
                        odds_b3_string),
  check.names = F
)
rownames(tbl_intervalos_betas_odds)<-NULL
tbl_intervalos_betas_odds %>% 
  kableExtra::kbl(
    .,digits=3,align=c('l','c','c','c'),booktabs = T,
    caption = 'Intervalos de confiança (95\\%) para o modelo final') %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")

pontos_x3 = seq(from=0, to=max(amostra$X3), by=0.01)
B0 = modelo_final_complexo$coefficients[1]
B1_X3 = modelo_final_complexo$coefficients[2]
B2_X1 = modelo_final_complexo$coefficients[3]
B3_X2 = modelo_final_complexo$coefficients[4]

map_df(0:1, function(x1_dummy) {
  map_df(0:1, function(x2_dummy) {
    tibble(
      x1=x1_dummy,
      x2=x2_dummy,
      grupo=str_c("(X1=",x1,", X2=",x2, ")"),
      x3=pontos_x3,
      logito=B0 + B1_X3*x3 + B2_X1*x1 + B3_X2*x2,
      prob=exp(logito)/(1 + exp(logito)),
    )
  })
}) %>%
  ggplot() +
  geom_path(aes(x=x3, y=prob, color=grupo, group=grupo))+ theme_bw()


```